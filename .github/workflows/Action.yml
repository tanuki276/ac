name: Android CI/CD

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # 毎日2時（UTC）に実行
    - cron: '0 2 * * *'

# 環境変数
env:
  GRADLE_VERSION: '8.4'
  JAVA_VERSION: '17'
  ANDROID_COMPILE_SDK: 34
  ANDROID_BUILD_TOOLS: '34.0.0'
  ANDROID_MIN_SDK: 24
  ANDROID_TARGET_SDK: 34

jobs:
  # 品質チェック
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: ${{ env.GRADLE_VERSION }}
        
    - name: Cache Gradle Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          .gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Validate Gradle Wrapper
      run: ./gradlew wrapper --validate
      
    - name: Check Formatting
      run: ./gradlew ktlintCheck
      
    - name: Static Analysis
      run: ./gradlew detekt
      
    - name: Dependency Check
      run: ./gradlew dependencyCheckAnalyze
      
    - name: Upload Detekt Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: detekt-reports
        path: app/build/reports/detekt/
        
  # ユニットテスト
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quality
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      
    - name: Cache Gradle Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Run Unit Tests
      run: ./gradlew testDebugUnitTest
      
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: app/build/reports/tests/
        
  # Androidテスト
  android-tests:
    name: Android Tests
    runs-on: macos-latest  # macOSが必要
    needs: unit-tests
    
    env:
      EMULATOR_API_LEVEL: 34
      EMULATOR_ARCH: x86_64
      EMULATOR_PROFILE: pixel_6
      
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      
    - name: Cache Gradle Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Create AVD
      uses: actions/create-avd@v1
      with:
        api-level: ${{ env.EMULATOR_API_LEVEL }}
        arch: ${{ env.EMULATOR_ARCH }}
        profile: ${{ env.EMULATOR_PROFILE }}
        force-avd-creation: true
        emulator-options: '-no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none'
        disable-animations: true
        
    - name: Start Emulator
      run: |
        echo "Starting emulator..."
        emulator -avd test -no-window -no-boot-anim -no-audio -gpu swiftshader_indirect &
        $ANDROID_HOME/platform-tools/adb wait-for-device shell \
          'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done; input keyevent 82'
        echo "Emulator started"
        
    - name: Run Android Tests
      timeout-minutes: 30
      run: ./gradlew connectedDebugAndroidTest
      
    - name: Upload Android Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: android-test-results
        path: app/build/reports/androidTests/
        
  # デバッグビルド
  build-debug:
    name: Build Debug APK
    runs-on: ubuntu-latest
    needs: [quality, unit-tests]
    
    outputs:
      version-code: ${{ steps.extract-version.outputs.version-code }}
      version-name: ${{ steps.extract-version.outputs.version-name }}
      
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Extract Version Info
      id: extract-version
      run: |
        VERSION_CODE=$(grep 'versionCode' app/build.gradle.kts | sed 's/[^0-9]*//g')
        VERSION_NAME=$(grep 'versionName' app/build.gradle.kts | cut -d'"' -f2)
        echo "version-code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "version-name=$VERSION_NAME" >> $GITHUB_OUTPUT
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      
    - name: Cache Gradle Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Build Debug APK
      run: |
        ./gradlew assembleDebug
        ./gradlew bundleDebug
        
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: nyanko-wars-debug
        path: |
          app/build/outputs/apk/debug/*.apk
          app/build/outputs/bundle/debug/*.aab
        retention-days: 7
        
    - name: Upload Mapping Files
      uses: actions/upload-artifact@v4
      with:
        name: debug-mapping
        path: app/build/outputs/mapping/debug/
        retention-days: 30
        
  # リリースビルド
  build-release:
    name: Build Release APK
    runs-on: ubuntu-latest
    needs: [quality, unit-tests, android-tests]
    if: startsWith(github.ref, 'refs/tags/v')
    
    env:
      KEYSTORE_FILE: release.keystore
      KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
      
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Decode Keystore
      run: |
        echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 --decode > $KEYSTORE_FILE
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      
    - name: Cache Gradle Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Build Release APK
      run: |
        ./gradlew assembleRelease \
          -PRELEASE_STORE_FILE=$KEYSTORE_FILE \
          -PRELEASE_STORE_PASSWORD=$KEYSTORE_PASSWORD \
          -PRELEASE_KEY_ALIAS=$KEY_ALIAS \
          -PRELEASE_KEY_PASSWORD=$KEY_PASSWORD
          
    - name: Build Release Bundle
      run: |
        ./gradlew bundleRelease \
          -PRELEASE_STORE_FILE=$KEYSTORE_FILE \
          -PRELEASE_STORE_PASSWORD=$KEYSTORE_PASSWORD \
          -PRELEASE_KEY_ALIAS=$KEY_ALIAS \
          -PRELEASE_KEY_PASSWORD=$KEY_PASSWORD
          
    - name: Sign APK with apksigner
      run: |
        $ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS }}/apksigner sign \
          --ks $KEYSTORE_FILE \
          --ks-pass pass:$KEYSTORE_PASSWORD \
          --key-pass pass:$KEY_PASSWORD \
          --ks-key-alias $KEY_ALIAS \
          --out app/build/outputs/apk/release/app-release-signed.apk \
          app/build/outputs/apk/release/app-release-unsigned.apk
          
    - name: Verify APK Signature
      run: |
        $ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS }}/apksigner verify \
          --verbose \
          app/build/outputs/apk/release/app-release-signed.apk
          
    - name: Upload Release Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nyanko-wars-release-${{ github.ref_name }}
        path: |
          app/build/outputs/apk/release/*-signed.apk
          app/build/outputs/bundle/release/*.aab
        retention-days: 90
        
    - name: Upload Release Notes
      run: |
        cat > release-notes.md << EOF
        # にゃんこ大戦争 ${{ needs.build-debug.outputs.version-name }}
        
        ## 変更点
        \`\`\`
        $(git log --oneline $(git describe --tags --abbrev=0 2>/dev/null || echo "HEAD~5")..HEAD)
        \`\`\`
        
        ## ビルド情報
        - バージョン: ${{ needs.build-debug.outputs.version-name }}
        - バージョンコード: ${{ needs.build-debug.outputs.version-code }}
        - ビルド日時: $(date)
        - コミット: ${{ github.sha }}
        EOF
        
    - name: Upload Release Mapping
      uses: actions/upload-artifact@v4
      with:
        name: release-mapping-${{ github.ref_name }}
        path: app/build/outputs/mapping/release/
        retention-days: 365
        
  # GitHub Release作成
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-release
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download Release Artifacts
      uses: actions/download-artifact@v4
      with:
        name: nyanko-wars-release-${{ github.ref_name }}
        path: release-artifacts
        
    - name: Download Release Notes
      uses: actions/download-artifact@v4
      with:
        name: release-notes
        path: .
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }}
        body_path: release-notes.md
        draft: false
        prerelease: false
        files: |
          release-artifacts/*.apk
          release-artifacts/*.aab
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
  # Firebase App Distribution
  firebase-distribution:
    name: Firebase Distribution
    runs-on: ubuntu-latest
    needs: build-debug
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: Download Debug Artifacts
      uses: actions/download-artifact@v4
      with:
        name: nyanko-wars-debug
        
    - name: Firebase App Distribution
      uses: wzieba/Firebase-Distribution-Github-Action@v1
      with:
        appId: ${{ secrets.FIREBASE_APP_ID }}
        serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        groups: testers
        file: app/build/outputs/apk/debug/*.apk
        
  # Play Store Deployment (内部テスト)
  play-store-internal:
    name: Deploy to Play Store (Internal)
    runs-on: ubuntu-latest
    needs: build-release
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download Release Bundle
      uses: actions/download-artifact@v4
      with:
        name: nyanko-wars-release-${{ github.ref_name }}
        
    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true
        
    - name: Deploy to Play Store (Internal)
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.GCP_SA_KEY }}
        packageName: com.nyankowars
        releaseFiles: app/build/outputs/bundle/release/*.aab
        track: internal
        status: completed